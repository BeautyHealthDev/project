name: Featured (yellow) consultants E-mail contacts preparation

on:
  workflow_dispatch:

jobs:
  build-contacts-list:
    runs-on: ubuntu-latest
    env:
      REPORT: 'ConsultantTreeMLM_JULIA'
    permissions:
      contents: write  # Разрешает пуш в репозиторий
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y xsltproc jq

      - name: Transform XML to JSON
        run: |
          echo "Запуск трансформации"
          xsltproc mailing/contacts_yellow_ConsultantTreeMLM.xsl mailing/${REPORT}.xml > contacts_yellow.json  2>/dev/null 
          
          COUNT=$(jq '. | length' contacts_yellow.json)
          echo "Найдено контактов: $COUNT"

      - name: Fix, Validate and Log Deleted Contacts
        id: prepare_json
        run: |
          # 1. Исправляем опечатки и отсекаем хвосты (sed)
          sed -E -e 's|(@[a-zA-Z0-9.-]+\.com)[^"]*|\1|g' \
                 -e 's|(@[a-zA-Z0-9.-]+\.ru)[^"]*|\1|g' \
                 -e 's|(@[a-zA-Z0-9.-]+\.net)[^"]*|\1|g' \
                 -e 's|@gemail\.com|@gmail.com|g' \
                 -e 's|@gmail\.cmooom|@gmail.com|g' \
                 -e 's|@gmail\.commom|@gmail.com|g' \
                 -e 's|@gmail\.commmooom|@gmail.com|g' \
                 -e 's|@gmayil\.com|@gmail.com|g' \
                 -e 's|@gamil\.com|@gmail.com|g' \
                 -e 's|@mailr\.u|@mail.ru|g' \
                 -e 's|@andex\.ru|@yandex.ru|g' \
                 contacts_yellow.json > fixed_contacts.json

          # 2. Логируем удаленные (битые) адреса
          # Находим разницу между всеми контактами и валидными
          echo "=== СПИСОК УДАЛЕННЫХ (НЕКОРРЕКТНЫХ) АДРЕСОВ ==="
          jq -r '.[] | select(.email == null or (.email | test("^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$") | not)) | "Удален адрес: \(.email), имя: \(.name)"' fixed_contacts.json || echo "Битых или пустых адресов не найдено."
          echo "==============================================="

          # 3. Валидация через jq: оставляем только корректные
          jq -c '[.[] | select(.email != null and (.email | test("^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$")))]' fixed_contacts.json > validated_contacts.json

          # Итоговая статистика
          echo "Успешно валидировано: $(jq '. | length' validated_contacts.json) контактов."
          cat "validated_contacts.json"

          # Разрезаем файл на части
          jq -c '.[0:900]' validated_contacts.json > part_1.json
          jq -c '.[900:1800]' validated_contacts.json > part_2.json
          jq -c '.[1800:]' validated_contacts.json > part_3.json
          
          # Логируем количество контактов в каждой части для проверки
          echo "Part 1 (900): $(jq '. | length' part_1.json)"
          echo "Part 2 (900): $(jq '. | length' part_2.json)"
          echo "Part 3 (Remainder): $(jq '. | length' part_3.json

      - name: Commit and Push to mailing directory
        run: |
          # 1. Настройка данных бота GitHub
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 2. Перемещаем файл в целевой каталог
          mkdir -p mailing
          mv part_1.json mailing/contacts_yellow.json
          mv part_2.json mailing/contacts_yellow2.json
          mv part_3.json mailing/contacts_yellow3.json
          
          # 3. Добавляем файлы, фиксируем изменения и отправляем
          git add mailing/contacts_yellow*.json
          
          
          # Проверяем, есть ли реальные изменения, чтобы не падать на пустом коммите
          if git diff --staged --quiet; then
            echo "Изменений в файле для сохранения не обнаружено."
          else
            git commit -m "Update mailing contacts for Featured (yellow) consultants"
            # Используем --rebase, чтобы параллельные запуски матрицы не конфликтовали
            git pull --rebase origin main
            git push origin main
          fi
