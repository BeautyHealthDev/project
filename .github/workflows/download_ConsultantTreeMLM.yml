name: Download ConsultantTreeMLM XML

on:
  schedule:
      - cron: '0 3 * * *' # Раз в день
  workflow_dispatch: # Позволяет запускать вручную
    inputs:
        period:
          description: 'Период'
          required: true
          default: '02/2026'
          type: choice
          options:
            - 01/2026
            - 02/2026
            - 03/2026
        nullsum:
          description: 'Включить неактивных Консультантов'
          default: 'Да'
          type: choice
          options:
            - Да
            - Нет
        ownstructure:
          description: 'Показывать только свою структуру'
          default: 'Да'
          type: choice
          options:
            - Да
            - Нет
          
jobs:
  download-report:
    runs-on: ubuntu-latest
    strategy:
      # Чтобы ошибки в одном ID не прерывали остальные, поставьте false
      fail-fast: false 
      matrix:
        include:
          - name: "JULIA"
            cons_id: "1001494180387"
          - name: "ALEXANDER"
            cons_id: "1001529788922"
          - name: "KSENIA"
            cons_id: "1001733594981"
          - name: "VLAD"
            cons_id: "1001746170633"
          - name: "NB"
            cons_id: "1001773422929"
          - name: "NATASHA"
            cons_id: "1001783608329"
    permissions:
      contents: write  # Разрешает пуш в репозиторий
    steps:
      # ЭТОТ ШАГ ОБЯЗАТЕЛЕН: он скачивает ваш script_web.js в Runner
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTION_PAT }}
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install playwright
          npx playwright install chromium --with-deps
          
      - name: Install Prettier
        run: npm install prettier @prettier/plugin-xml
    
      - name: Run Playwright script for ${{ matrix.name }}
        env:
          # Если matrix.name = 'JULIA', возьмет секрет FABERLIC_USER_JULIA
          USER: ${{ secrets[format('FABERLIC_USER_{0}', matrix.name)] }}
          # Аналогично для пароля FABERLIC_KEY_JULIA
          PASS: ${{ secrets[format('FABERLIC_KEY_{0}', matrix.name)] }}
          PERIOD: >-
            ${{ 
              inputs.period == '01/2026' && '30000000520' || 
              inputs.period == '02/2026' && '30000000521' || 
              inputs.period == '03/2026' && '30000000522' ||
              '30000000521'
            }}
          NULLSUM: ${{ contains(inputs.nullsum, 'Нет') && '0' || '1' }}
          OWNSTRUCTURE: ${{ contains(inputs.ownstructure, 'Нет') && '0' || '1' }}
          REPORT: 'ConsultantTreeMLM'
          # Берем значение из матрицы
          NAME: ${{ matrix.name }} 
          CONS: ${{ matrix.cons_id }} 
        run: |
          echo "Запуск для: ${{ matrix.name }} (ID: $CONS)"
          node mailing/script_load_report_xml.js

          
      - name: Upload XML result to mailing folder
        env:
          FILE: 'ConsultantTreeMLM${{ matrix.name }}.xml'
        run: |
          # Создаем папку, если она не существует
          mkdir -p mailing
          # Перемещаем файл в целевую папку
          mv $FILE mailing/
          # Format XML (Сразу после загрузки)
          run: npx prettier --write "mailing/$FILE" --plugin=@prettier/plugin-xml

      - name: Commit Beautiful XML
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ConsultantTreeMLM: update and format report"
          file_pattern: 'mailing/ConsultantTreeMLM${{ matrix.name }}.xml'
