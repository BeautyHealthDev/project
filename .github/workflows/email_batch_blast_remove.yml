name: 14-Day Sequential Blast to Removed 6 or 18

on:
  schedule:
    - cron: '0 10 * * *' # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 13:00 –ú–°–ö
  workflow_dispatch:
    inputs:
      force_offset_day:
        description: '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å —Ä–∞—Å—Å—ã–ª–∫–∏ (0-13)'
        required: false
      idle_periods:
        description: '–ü–µ—Ä–∏–æ–¥—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏'
        required: true
        default: '18'
        type: choice
        options:
          - 6
          - 18

jobs:
  prepare-slice:
    runs-on: ubuntu-latest
    env:
      MAILING_START_DATE: '2026-05-09'
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      current_day: ${{ steps.calc.outputs.day_diff }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate Current Day from Start
        id: calc
        run: |
          # 1. –ë–µ—Ä–µ–º –¥–∞—Ç—É —Å—Ç–∞—Ä—Ç–∞ –∏–∑ —Å–µ–∫—Ä–µ—Ç–∞ –∏–ª–∏ —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç
          START_DATE="${{ env.MAILING_START_DATE }}"
          
          # 2. –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –¥–Ω—è—Ö –º–µ–∂–¥—É –°–ï–ì–û–î–ù–Ø –∏ START_DATE
          CURRENT_SEC=$(date +%s)
          START_SEC=$(date -d "$START_DATE" +%s)
          DAY_DIFF=$(( (CURRENT_SEC - START_SEC) / 86400 ))
          
          # 3. –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫ —Ä—É—á–Ω–æ–π - –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å
          if [ -n "${{ github.event.inputs.force_offset_day }}" ]; then
            DAY_DIFF=${{ github.event.inputs.force_offset_day }}
          fi

          # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –≤—ã—à–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã 14 –¥–Ω–µ–π - —Å—Ç–æ–ø
          if [ "$DAY_DIFF" -lt 0 ] || [ "$DAY_DIFF" -ge 14 ]; then
            echo "–¢–µ–∫—É—â–∏–π –¥–µ–Ω—å ($DAY_DIFF) –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 0-13. –†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
            exit 0
          fi

          echo "day_diff=$DAY_DIFF" >> $GITHUB_OUTPUT
          echo "offset=$(( DAY_DIFF * 200 ))" >> $GITHUB_OUTPUT

      - name: Slice Contacts
        id: set-matrix
        env:
          # –ï—Å–ª–∏ inputs.idle_periods —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç, –±–µ—Ä–µ–º –µ–≥–æ. –ò–Ω–∞—á–µ '6'
          IDLE_PERIODS: ${{ inputs.idle_periods || '6' }}
        run: |
          # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫–∏ –∏ –±–µ—Ä–µ–º —Å—Ä–µ–∑ 200 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
          OFFSET=${{ steps.calc.outputs.offset }}
          LIMIT=200
          
          # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è + –°–ª–∞–π—Å–∏–Ω–≥
          # JSON=$(jq -c "[.[] | select(.email != null and (.email | test(\"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}$\")))] | .[$OFFSET:$OFFSET+$LIMIT]" mailing/contacts_remove${IDLE_PERIODS}.json)
          JSON=$(jq -c "[.[] | select(.email != null and (.email | test(\"^[a-zA-Z0-9._%+-]+@gmail\\.com$\")))] | .[$OFFSET:$OFFSET+$LIMIT]" mailing/contacts_remove${IDLE_PERIODS}.json)

          
          if [ "$JSON" == "[]" ] || [ -z "$JSON" ]; then
            echo "–ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –¥–Ω—è ${{ steps.calc.outputs.day_diff }} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            exit 0
          fi
          
          echo "matrix=${JSON}" >> $GITHUB_OUTPUT

  send-emails:
    needs: prepare-slice
    env:
      MAILING_STOPPED: true
    strategy:
      fail-fast: false 
      max-parallel: 1
      matrix:
        contact: ${{ fromJson(needs.prepare-slice.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check for Critical Error Threshold
        id: breaker
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª-–º–µ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å–æ–∑–¥–∞–Ω–Ω—ã–π –≤ –¥—Ä—É–≥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏)
          if [ -f "STOP_MAILING" ]; then
            echo "MAILING_STOPPED=true" >> $GITHUB_ENV
            echo "üö® –†–∞—Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –æ—à–∏–±–æ–∫!"
            exit 1 # –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é
          fi
      
      - name: Prepare Template for ${{ matrix.contact.name }}
        env:
          IDLE_PERIODS: ${{ inputs.idle_periods || '6' }}
        id: prepare_template
        run: |
          # –î–ê–¢–ê_–û–ö–û–ù–ß–ê–ù–ò–Ø_–ö–ê–¢–ê–õ–û–ì–ê
          CAT_END="15 —Ñ–µ–≤—Ä–∞–ª—è 2026"
      
          # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª, –∑–∞–º–µ–Ω—è–µ–º –ø–æ–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –º–∞—Ç—Ä–∏—Ü—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          sed \
              -e "s|%–§–ò–û%|${{ matrix.contact.name }}|g" \
              -e "s|%–§–ê–ú–ò–õ–ò–Ø%|${{ matrix.contact.lastname }}|g" \
              -e "s|%–ò–ú–Ø%|${{ matrix.contact.firstname }}|g" \
              -e "s|%–û–¢–ß–ï–°–¢–í–û%|${{ matrix.contact.patronymic }}|g" \
              -e "s|%–ù–û–ú–ï–†_–ö–û–ù–°–£–õ–¨–¢–ê–ù–¢–ê%|${{ matrix.contact.cons_number }}|g" \
              -e "s|%EMAIL%|${{ matrix.contact.email }}|g" \
              -e "s|%–ù–ê–°–¢–ê–í–ù–ò–ö_–§–ò–û%|${{ matrix.contact.tutor_name }}|g" \
              -e "s|%–ù–ê–°–¢–ê–í–ù–ò–ö_–¢–ï–õ–ï–§–û–ù%|${{ matrix.contact.tutor_phone }}|g" \
              -e "s|%–ù–ê–°–¢–ê–í–ù–ò–ö_EMAIL%|${{ matrix.contact.tutor_email }}|g" \
              -e "s|%–î–ê–¢–ê_–û–ö–û–ù–ß–ê–ù–ò–Ø_–ö–ê–¢–ê–õ–û–ì–ê%|${CAT_END}|g" \
              mailing/remove${IDLE_PERIODS}.txt > prepared_email.txt
          cat "prepared_email.txt" 
          
      - name: Send Mail
        if: env.MAILING_STOPPED != 'true'
        id: send_mail
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME2 }}
          password: ${{ secrets.MAIL_PASSWORD2 }}
          subject: "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –≤ Faberlic —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω"
          to: ${{ matrix.contact.email }}
          from: "–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞ Faberlic <${{ secrets.MAIL_USERNAME2 }}>"
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–∂–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          body: file://prepared_email.txt

      - name: Handle Success/Failure Counter
        if: always()
        run: |
          # –ü—É—Ç—å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Å—á–µ—Ç—á–∏–∫—É –æ—à–∏–±–æ–∫
          ERR_FILE="consecutive_errors.txt"
          
          if [ "${{ steps.send_mail.outcome }}" == "failure" ]; then
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
            COUNT=$(cat $ERR_FILE 2>/dev/null || echo 0)
            COUNT=$((COUNT + 1))
            echo $COUNT > $ERR_FILE
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–¥—Ä—è–¥: $COUNT"
            
            if [ "$COUNT" -ge 10 ]; then
              echo "!!! –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ö–û–õ–ò–ß–ï–°–¢–í–û –û–®–ò–ë–û–ö !!!"
              touch STOP_MAILING
              # –í —Ä–µ–∞–ª—å–Ω–æ–π –º–∞—Ç—Ä–∏—Ü–µ GitHub –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏ 
              # –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Artifacts –∏–ª–∏ Cache, –Ω–æ –ø—Ä–∏ max-parallel: 1 
              # –º—ã –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–∂–æ–±.
            fi
            
            # –õ–æ–≥–∏—Ä—É–µ–º email –¥–ª—è –æ—Ç—á–µ—Ç–∞
            echo "‚ùå –û—à–∏–±–∫–∞: ${{ matrix.contact.email }}" >> error_emails.txt
          else
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
            echo 0 > $ERR_FILE
          fi

      - name: Upload Error Status
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: status-${{ strategy.job-index }}
          path: |
            error_emails.txt
            STOP_MAILING
          retention-days: 1

      - name: Wait
        if: env.MAILING_STOPPED != 'true'
        run: sleep 5

  send-report:
    runs-on: ubuntu-latest
    needs: [prepare-slice, send-emails]
    if: always()
    steps:
      - name: Download all error logs
        uses: actions/download-artifact@v4
        with:
          path: all-errors
          pattern: error-logs-*
          merge-multiple: true
        continue-on-error: true

      - name: Prepare Error Message
        id: err_list
        run: |
          if [ -f "all-errors/error_emails.txt" ]; then
            # –ß–∏—Ç–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –¥–ª—è Telegram (–º–∞–∫—Å 4096 —Å–∏–º–≤)
            ERRORS=$(cat all-errors/error_emails.txt | head -n 20)
            echo "list<<EOF" >> $GITHUB_OUTPUT
            echo "$ERRORS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "list=–û—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ" >> $GITHUB_OUTPUT
          fi

      - name: Telegram Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üìÖ –î–µ–Ω—å —Ä–∞—Å—Å—ã–ª–∫–∏: ${{ needs.prepare-slice.outputs.current_day }} –∏–∑ 14
            üìä –°—Ç–∞—Ç—É—Å: ${{ needs.send-emails.result }}
            
            ‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ (–ø–µ—Ä–≤—ã–µ 20):
            ${{ steps.err_list.outputs.list }}
            
            üîó –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏: https://github.com{{ github.repository }}/actions/runs/${{ github.run_id }}

