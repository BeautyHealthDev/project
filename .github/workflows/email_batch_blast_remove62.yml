name: 2-nd Part Sequential Blast to Removed 6

on:
  schedule:
    - cron: '0 8 * * *' # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 11:00 –ú–°–ö
  workflow_dispatch:
    inputs:
      force_cons_number:
        description: '–ù–∞—á–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É —Å –Ω–æ–º–µ—Ä–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 744707107)'
        required: false
        default: ''
      force_offset_day:
        description: '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å —Ä–∞—Å—Å—ã–ª–∫–∏ (0-13)'
        required: false
      idle_periods:
        description: '–ü–µ—Ä–∏–æ–¥—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏'
        required: true
        default: '6'
        type: choice
        options:
          - 6

jobs:
  prepare-slice:
    runs-on: ubuntu-latest
    env:
      MAILING_START_DATE: '2026-02-18'
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      current_day: ${{ steps.calc.outputs.day_diff }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate Current Day from Start
        id: calc
        run: |
          # 1. –ë–µ—Ä–µ–º –¥–∞—Ç—É —Å—Ç–∞—Ä—Ç–∞ –∏–∑ env
          START_DATE="${{ env.MAILING_START_DATE }}"
          
          # 2. –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –¥–Ω—è—Ö –º–µ–∂–¥—É –°–ï–ì–û–î–ù–Ø –∏ START_DATE
          CURRENT_SEC=$(date +%s)
          START_SEC=$(date -d "$START_DATE" +%s)
          DAY_DIFF=$(( (CURRENT_SEC - START_SEC) / 86400 ))
          
          # 3. –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫ —Ä—É—á–Ω–æ–π - –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å
          if [ -n "${{ github.event.inputs.force_offset_day }}" ]; then
            DAY_DIFF=${{ github.event.inputs.force_offset_day }}
          fi

          # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –≤—ã—à–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã 14 –¥–Ω–µ–π - —Å—Ç–æ–ø
          if [ "$DAY_DIFF" -lt 0 ] || [ "$DAY_DIFF" -ge 14 ]; then
            echo "–¢–µ–∫—É—â–∏–π –¥–µ–Ω—å ($DAY_DIFF) –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 0-13. –†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
            exit 0
          fi

          echo "day_diff=$DAY_DIFF" >> $GITHUB_OUTPUT
          echo "offset=$(( DAY_DIFF * 100 ))" >> $GITHUB_OUTPUT

      - name: Slice Contacts
        id: set-matrix
        env:
          # –ï—Å–ª–∏ inputs.idle_periods —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç, –±–µ—Ä–µ–º –µ–≥–æ. –ò–Ω–∞—á–µ '6'
          IDLE_PERIODS: ${{ inputs.idle_periods || '6' }}
        run: |
          # 1. –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
          OFFSET=${{ steps.calc.outputs.offset }}
          LIMIT=100
          FORCE_CONS="${{ github.event.inputs.force_cons_number }}"
          FILE="mailing/contacts_remove${IDLE_PERIODS}2.json"

          # 2. –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã—Ö Gmail –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          jq -c '[.[] | select(.email != null and (.email | test("@gmail\\.com$")))]' "$FILE" > temp_valid.json

          # 3. –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
          if [ -n "$FORCE_CONS" ]; then
            echo "–ü–æ–∏—Å–∫ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞: $FORCE_CONS"
            
            # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —ç–ª–µ–º–µ–Ω—Ç–∞, —É –∫–æ—Ç–æ—Ä–æ–≥–æ cons_number —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤–≤–æ–¥–æ–º
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, index –≤–µ—Ä–Ω–µ—Ç null, —Ç–æ–≥–¥–∞ –Ω–∞—á–Ω–µ–º —Å 0
            START_INDEX=$(jq "map(.cons_number == \"$FORCE_CONS\") | index(true) // 0" temp_valid.json)
            
            echo "–ù–∞–π–¥–µ–Ω –∏–Ω–¥–µ–∫—Å: $START_INDEX. –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π OFFSET."
            JSON=$(jq -c ".[$START_INDEX:$START_INDEX+$LIMIT]" temp_valid.json)
          else
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ –¥–Ω—è–º (—Å–º–µ—â–µ–Ω–∏–µ OFFSET)
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–Ω—è: $OFFSET"
            JSON=$(jq -c ".[$OFFSET:$OFFSET+$LIMIT]" temp_valid.json)
          fi

          # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É –∏ –≤—ã–≤–æ–¥
          if [ "$JSON" == "[]" ] || [ -z "$JSON" ]; then
            echo "–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            exit 0
          fi
          echo "matrix=${JSON}" >> $GITHUB_OUTPUT

  send-emails:
    needs: prepare-slice
    env:
      MAILING_STOPPED: false
    strategy:
      fail-fast: true # <--- –≠–¢–û –û–°–¢–ê–ù–û–í–ò–¢ –í–°–Æ –ú–ê–¢–†–ò–¶–£ –ü–†–ò –ü–ï–†–í–û–ô –ñ–ï –û–®–ò–ë–ö–ï 'exit 1'
      max-parallel: 1
      matrix:
        contact: ${{ fromJson(needs.prepare-slice.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Prepare Template for ${{ matrix.contact.name }}
        env:
          IDLE_PERIODS: ${{ inputs.idle_periods || '6' }}
        id: prepare_template
        run: |
          # –î–ê–¢–ê_–û–ö–û–ù–ß–ê–ù–ò–Ø_–ö–ê–¢–ê–õ–û–ì–ê
          CAT_END="01 –º–∞—Ä—Ç–∞ 2026"
      
          # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª, –∑–∞–º–µ–Ω—è–µ–º –ø–æ–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –º–∞—Ç—Ä–∏—Ü—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          sed \
              -e "s|%–§–ò–û%|${{ matrix.contact.name }}|g" \
              -e "s|%–§–ê–ú–ò–õ–ò–Ø%|${{ matrix.contact.lastname }}|g" \
              -e "s|%–ò–ú–Ø%|${{ matrix.contact.firstname }}|g" \
              -e "s|%–û–¢–ß–ï–°–¢–í–û%|${{ matrix.contact.patronymic }}|g" \
              -e "s|%–ù–û–ú–ï–†_–ö–û–ù–°–£–õ–¨–¢–ê–ù–¢–ê%|${{ matrix.contact.cons_number }}|g" \
              -e "s|%EMAIL%|${{ matrix.contact.email }}|g" \
              -e "s|%–ù–ê–°–¢–ê–í–ù–ò–ö_–§–ò–û%|${{ matrix.contact.tutor_name }}|g" \
              -e "s|%–ù–ê–°–¢–ê–í–ù–ò–ö_–¢–ï–õ–ï–§–û–ù%|${{ matrix.contact.tutor_phone }}|g" \
              -e "s|%–ù–ê–°–¢–ê–í–ù–ò–ö_EMAIL%|${{ matrix.contact.tutor_email }}|g" \
              -e "s|%–î–ê–¢–ê_–û–ö–û–ù–ß–ê–ù–ò–Ø_–ö–ê–¢–ê–õ–û–ì–ê%|${CAT_END}|g" \
              mailing/remove${IDLE_PERIODS}.txt > prepared_email.txt
          cat "prepared_email.txt" 
          
      - name: Send Mail
        if: env.MAILING_STOPPED != 'true'
        id: send_mail
        # –£–ë–ò–†–ê–ï–ú continue-on-error: true
        # –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –æ—à–∏–±–∫–µ 550 5.4.5 —ç—Ç–æ—Ç —à–∞–≥ –ü–†–ï–†–í–ï–¢ –¥–∂–æ–±—É
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Å–µ–∫—Ä–µ—Ç–∞: MAIL_USERNAME + –Ω–æ–º–µ—Ä
          username: ${{ secrets[format('MAIL_USERNAME{0}', '2')] }}
          password: ${{ secrets[format('MAIL_PASSWORD{0}', '2')] }}
          subject: "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –≤ Faberlic —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω"
          to: ${{ matrix.contact.email }}
          from: "–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞ Faberlic <${{ secrets[format('MAIL_USERNAME{0}', '2')] }}>"
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–∂–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          body: file://prepared_email.txt

      # –≠—Ç–æ—Ç —à–∞–≥ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ—á—Ç–∞ —É—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
      - name: Log Success
        if: success()
        run: touch "success_${{ strategy.job-index }}"

      # –≠—Ç–æ—Ç —à–∞–≥ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ—á—Ç–∞ –ù–ï —É—à–ª–∞ (–≤–∫–ª—é—á–∞—è –ª–∏–º–∏—Ç 550)
      - name: Log Error
        if: failure()
        run: |
          echo "‚ùå –û—à–∏–±–∫–∞: ${{ matrix.contact.email }}" >> error_emails.txt
          echo "üö® –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ (–≤–æ–∑–º–æ–∂–Ω–æ –ª–∏–º–∏—Ç Gmail). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ."

      - name: Upload Success Marker
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: success-marker-${{ strategy.job-index }}
          path: success_*
          retention-days: 1
      
      - name: Upload Error Status
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: status-${{ strategy.job-index }}
          path: |
            error_emails.txt
          retention-days: 1

      - name: Wait
        if: env.MAILING_STOPPED != 'true'
        run: sleep 5

  send-report:
    runs-on: ubuntu-latest
    needs: [prepare-slice, send-emails]
    if: always()
    steps:
      - name: Download Success Markers
        uses: actions/download-artifact@v4
        with:
          path: all-success
          pattern: success-marker-*
          merge-multiple: true
        continue-on-error: true

      - name: Calculate Total Success
        id: total
        run: |
          if [ -d "all-success" ]; then
            # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –º–∞—Ä–∫–µ—Ä–æ–≤
            COUNT=$(ls all-success/success_* 2>/dev/null | wc -l)
            echo "total_success=$COUNT" >> $GITHUB_OUTPUT
          else
            echo "total_success=0" >> $GITHUB_OUTPUT
          fi

        # –£–¥–∞–ª–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–¥—Å—á–µ—Ç–∞
      - name: Clean up success markers
        uses: geekyeggo/delete-artifact@v5
        with:
          # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã, –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ–¥ –º–∞—Å–∫—É
          name: success-marker-*
          use_glob: true
          fail_on_missing: false
      
      - name: Download all error logs
        uses: actions/download-artifact@v4
        with:
          path: all-errors
          pattern: error-logs-*
          merge-multiple: true
        continue-on-error: true

      - name: Prepare Error Message
        id: err_list
        run: |
          if [ -f "all-errors/error_emails.txt" ]; then
            # –ß–∏—Ç–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –¥–ª—è Telegram (–º–∞–∫—Å 4096 —Å–∏–º–≤)
            ERRORS=$(cat all-errors/error_emails.txt | head -n 20)
            echo "list<<EOF" >> $GITHUB_OUTPUT
            echo "$ERRORS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "list=–û—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ" >> $GITHUB_OUTPUT
          fi

      - name: Telegram Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚úâÔ∏è –†–∞—Å—Å—ã–ª–∫–∞ –Æ–ª–∏—è
            üìÖ –î–µ–Ω—å —Ä–∞—Å—Å—ã–ª–∫–∏: ${{ needs.prepare-slice.outputs.current_day }} –∏–∑ 14
            üìä –°—Ç–∞—Ç—É—Å: ${{ needs.send-emails.result }}
            ‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${{ steps.total.outputs.total_success }}
            
            ‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ (–ø–µ—Ä–≤—ã–µ 5):
            ${{ steps.err_list.outputs.list }}
            
            üîó –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏: https://github.com{{ github.repository }}/actions/runs/${{ github.run_id }}

